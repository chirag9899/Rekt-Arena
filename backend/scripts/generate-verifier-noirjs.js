#!/usr/bin/env node
/**
 * Generate Solidity Verifier Contract using Noir.js
 * 
 * This script attempts to generate a Solidity verifier contract using Noir.js
 * programmatically, as an alternative to using the Barretenberg CLI.
 * 
 * Usage:
 *   node scripts/generate-verifier-noirjs.js
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { BarretenbergBackend } from '@noir-lang/backend_barretenberg';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const PROJECT_ROOT = join(__dirname, '../..');
const CIRCUIT_JSON = join(PROJECT_ROOT, 'circuits/solvency/target/solvency.json');
const OUTPUT_VERIFIER = join(PROJECT_ROOT, 'contracts/src/SolvencyVerifierGenerated.sol');

console.log('ğŸ”§ Generating Solidity Verifier using Noir.js\n');

// Step 1: Check if circuit is compiled
console.log('Step 1: Checking if circuit is compiled...');
if (!existsSync(CIRCUIT_JSON)) {
  console.error('âŒ Circuit not compiled!');
  console.error(`   Expected: ${CIRCUIT_JSON}`);
  console.error('\n   Please compile the circuit first:');
  console.error('   cd circuits/solvency && nargo compile');
  process.exit(1);
}
console.log('âœ… Circuit compiled\n');

// Step 2: Load circuit
console.log('Step 2: Loading circuit...');
let circuit;
try {
  circuit = JSON.parse(readFileSync(CIRCUIT_JSON, 'utf-8'));
  console.log('âœ… Circuit loaded\n');
} catch (error) {
  console.error('âŒ Failed to load circuit:', error.message);
  process.exit(1);
}

// Step 3: Initialize backend
console.log('Step 3: Initializing Barretenberg backend...');
let backend;
try {
  backend = new BarretenbergBackend(circuit);
  console.log('âœ… Backend initialized\n');
} catch (error) {
  console.error('âŒ Failed to initialize backend:', error.message);
  process.exit(1);
}

// Step 4: Try to generate verifier
console.log('Step 4: Attempting to generate verifier contract...');
try {
  // Check available methods
  const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(backend));
  console.log('Available backend methods:', methods.filter(m => !m.startsWith('_')).join(', '));
  
  // Try different possible method names
  let verifierContract = null;
  
  if (typeof backend.generateVerifierContract === 'function') {
    verifierContract = await backend.generateVerifierContract();
  } else if (typeof backend.getVerifierContract === 'function') {
    verifierContract = await backend.getVerifierContract();
  } else if (typeof backend.writeVerifierContract === 'function') {
    verifierContract = await backend.writeVerifierContract();
  } else {
    // Try to access internal methods or use a workaround
    console.log('âš ï¸  Direct verifier generation not available in this Noir.js version');
    console.log('\nğŸ“‹ Alternative: Use Barretenberg CLI (bb)');
    console.log('   1. Install Rust: https://rustup.rs/');
    console.log('   2. Build Barretenberg:');
    console.log('      git clone https://github.com/noir-lang/barretenberg.git');
    console.log('      cd barretenberg && cargo build --release');
    console.log('   3. Run: npm run generate-verifier');
    console.log('\n   Or use the manual method:');
    console.log('   cd circuits/solvency');
    console.log('   bb write_vk -b ./target/solvency.json -o ./target --oracle_hash keccak');
    console.log('   bb write_solidity_verifier -k ./target/vk -o ./target/Verifier.sol');
    
    await backend.destroy();
    process.exit(1);
  }
  
  if (!verifierContract) {
    throw new Error('Verifier generation returned null/undefined');
  }
  
  console.log('âœ… Verifier contract generated\n');
  
  // Step 5: Post-process and save
  console.log('Step 5: Post-processing and saving contract...');
  
  // Add header
  const header = `// SPDX-License-Identifier: MIT
/**
 * @title SolvencyVerifierGenerated
 * @notice Auto-generated Solidity verifier contract for the solvency ZK circuit
 * @dev This contract was generated from circuits/solvency using Noir.js
 * 
 * DO NOT EDIT THIS FILE MANUALLY
 * To regenerate: node backend/scripts/generate-verifier-noirjs.js
 * 
 * This verifier cryptographically verifies ZK proofs generated by the solvency circuit.
 * It proves that an agent is solvent (equity >= maintenance) without revealing
 * private inputs (collateral, position_size, entry_price).
 * 
 * Public inputs: [current_price, is_long, maintenance_percent, excess]
 */

`;
  
  const fullContract = header + verifierContract;
  writeFileSync(OUTPUT_VERIFIER, fullContract);
  console.log('âœ… Contract saved\n');
  
  // Cleanup
  await backend.destroy();
  
  // Step 6: Summary
  console.log('='.repeat(60));
  console.log('âœ… Verifier Generation Complete!');
  console.log('='.repeat(60));
  console.log(`\nğŸ“„ Generated verifier: ${OUTPUT_VERIFIER}`);
  console.log('\nğŸ“‹ Next Steps:');
  console.log('   1. Review the generated contract');
  console.log('   2. Update it to implement ISolvencyVerifier interface if needed');
  console.log('   3. Replace contracts/src/SolvencyVerifier.sol with the generated contract');
  console.log('   4. Test with real proofs before deployment');
  console.log('');
  
} catch (error) {
  console.error('âŒ Failed to generate verifier:', error.message);
  console.error('\nğŸ“‹ Alternative Methods:');
  console.error('   1. Install Barretenberg CLI (bb) and use: npm run generate-verifier');
  console.error('   2. Use manual generation (see VERIFIER_GENERATION.md)');
  console.error('   3. Wait for Noir.js to add verifier generation support');
  
  if (backend) {
    await backend.destroy();
  }
  process.exit(1);
}
