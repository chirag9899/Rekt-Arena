#!/usr/bin/env node
/**
 * Generate Solidity Verifier Contract from Noir Circuit
 * 
 * This script generates a Solidity verifier contract from the compiled Noir circuit.
 * It uses the Barretenberg CLI (bb) to generate the verification key and verifier contract.
 * 
 * Usage:
 *   node scripts/generate-verifier.js
 * 
 * Requirements:
 *   - Circuit must be compiled: cd circuits/solvency && nargo compile
 *   - Barretenberg CLI (bb) must be installed
 */

import { execSync } from 'child_process';
import { readFileSync, writeFileSync, existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const PROJECT_ROOT = join(__dirname, '../..');
const CIRCUIT_DIR = join(PROJECT_ROOT, 'circuits/solvency');
const CIRCUIT_JSON = join(CIRCUIT_DIR, 'target/solvency.json');
const TARGET_DIR = join(CIRCUIT_DIR, 'target');
const OUTPUT_VERIFIER = join(PROJECT_ROOT, 'contracts/src/SolvencyVerifierGenerated.sol');

console.log('üîß Generating Solidity Verifier from Noir Circuit\n');

// Step 1: Check if circuit is compiled
console.log('Step 1: Checking if circuit is compiled...');
if (!existsSync(CIRCUIT_JSON)) {
  console.error('‚ùå Circuit not compiled!');
  console.error(`   Expected: ${CIRCUIT_JSON}`);
  console.error('\n   Please compile the circuit first:');
  console.error('   cd circuits/solvency && nargo compile');
  process.exit(1);
}
console.log('‚úÖ Circuit compiled\n');

// Step 2: Check if bb (Barretenberg CLI) is available
console.log('Step 2: Checking for Barretenberg CLI (bb)...');
try {
  execSync('which bb', { stdio: 'pipe' });
  console.log('‚úÖ Barretenberg CLI found\n');
} catch (error) {
  console.error('‚ùå Barretenberg CLI (bb) not found!');
  console.error('\n   Please install Barretenberg CLI:');
  console.error('   Option 1: Install via npm (if available)');
  console.error('   Option 2: Build from source: https://github.com/noir-lang/barretenberg');
  console.error('   Option 3: Use Noir.js programmatic generation (see alternative method below)');
  console.error('\n   Alternatively, try using Noir.js to generate the verifier programmatically.');
  process.exit(1);
}

// Step 3: Generate verification key
console.log('Step 3: Generating verification key...');
try {
  execSync(
    `bb write_vk -b ${CIRCUIT_JSON} -o ${TARGET_DIR} --oracle_hash keccak`,
    { stdio: 'inherit', cwd: CIRCUIT_DIR }
  );
  console.log('‚úÖ Verification key generated\n');
} catch (error) {
  console.error('‚ùå Failed to generate verification key');
  console.error('   Error:', error.message);
  process.exit(1);
}

// Step 4: Generate Solidity verifier contract
console.log('Step 4: Generating Solidity verifier contract...');
try {
  const vkPath = join(TARGET_DIR, 'vk');
  execSync(
    `bb write_solidity_verifier -k ${vkPath} -o ${OUTPUT_VERIFIER}`,
    { stdio: 'inherit', cwd: CIRCUIT_DIR }
  );
  console.log('‚úÖ Solidity verifier contract generated\n');
} catch (error) {
  console.error('‚ùå Failed to generate Solidity verifier');
  console.error('   Error:', error.message);
  process.exit(1);
}

// Step 5: Post-process the generated contract
console.log('Step 5: Post-processing generated contract...');
try {
  let verifierCode = readFileSync(OUTPUT_VERIFIER, 'utf-8');
  
  // Add SPDX license if not present
  if (!verifierCode.includes('SPDX-License-Identifier')) {
    verifierCode = `// SPDX-License-Identifier: MIT\n${verifierCode}`;
  }
  
  // Add documentation header
  const header = `/**
 * @title SolvencyVerifierGenerated
 * @notice Auto-generated Solidity verifier contract for the solvency ZK circuit
 * @dev This contract was generated from circuits/solvency using Barretenberg
 * 
 * DO NOT EDIT THIS FILE MANUALLY
 * To regenerate: node backend/scripts/generate-verifier.js
 * 
 * This verifier cryptographically verifies ZK proofs generated by the solvency circuit.
 * It proves that an agent is solvent (equity >= maintenance) without revealing
 * private inputs (collateral, position_size, entry_price).
 * 
 * Public inputs: [current_price, is_long, maintenance_percent, excess]
 */

`;
  
  // Insert header after SPDX license
  if (verifierCode.startsWith('// SPDX')) {
    const lines = verifierCode.split('\n');
    const spdxLine = lines[0];
    const rest = lines.slice(1).join('\n');
    verifierCode = `${spdxLine}\n${header}${rest}`;
  } else {
    verifierCode = header + verifierCode;
  }
  
  // Update contract name to match interface
  verifierCode = verifierCode.replace(
    /contract\s+(\w+Verifier)/g,
    'contract SolvencyVerifierGenerated'
  );
  
  writeFileSync(OUTPUT_VERIFIER, verifierCode);
  console.log('‚úÖ Contract post-processed\n');
} catch (error) {
  console.warn('‚ö†Ô∏è  Warning: Failed to post-process contract:', error.message);
  console.warn('   The contract was generated but may need manual adjustments');
}

// Step 6: Summary
console.log('='.repeat(60));
console.log('‚úÖ Verifier Generation Complete!');
console.log('='.repeat(60));
console.log(`\nüìÑ Generated verifier: ${OUTPUT_VERIFIER}`);
console.log('\nüìã Next Steps:');
console.log('   1. Review the generated contract');
console.log('   2. Update it to implement ISolvencyVerifier interface');
console.log('   3. Replace contracts/src/SolvencyVerifier.sol with the generated contract');
console.log('   4. Test with real proofs before deployment');
console.log('\n‚ö†Ô∏è  Note: The generated contract may need adjustments to match');
console.log('   the ISolvencyVerifier interface signature.');
console.log('');
